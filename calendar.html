<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPP Meeting Room Booking - Version 4.4</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>        
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Text:wght@400;500;600&display=swap');
        
        body {
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }
        .container {
    display: flex;
    min-height: 100vh;
}
.sidebar {
    width: 250px;
    background-color: #ffffff;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 20px;
    overflow-y: auto;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
}
#main-content {
    flex-grow: 1;
    padding: 20px 20px 20px 270px;
}        
        .sidebar h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .analytics-card {
            background-color: #f5f5f7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .analytics-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .analytics-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .analytics-icon {
            font-size: 16px;
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }
        .analytics-label {
            flex-grow: 1;
            font-size: 14px;
            color: #86868b;
        }
        .analytics-value {
            font-weight: 500;
            font-size: 14px;
        }
        
        }
        #calendar {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .fc-header-toolbar {
            margin-bottom: 1.5em!important;
        }
        .fc-toolbar-title {
            font-size: 20px!important;
            font-weight: 600;
        }
        .fc-button-primary {
            background-color: #007aff!important;
            border-color: #007aff!important;
            font-weight: 500;
        }
        .fc-button-primary:hover {
            background-color: #0056b3!important;
        }
        .fc-day-today {
            background-color: #e8f4ff!important;
        }
        .islamic-date {
            font-size: 10px;
            color: #86868b;
            text-align: right;
            padding-right: 5px;
        }
        #logoutButton {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background-color: #ff3b30;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .booking-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 300px;
        }
        .booking-form input, .booking-form select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'SF Pro Text', sans-serif;
        }
        .booking-form button {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            margin-top: 10px;
        }
        .booking-form button.cancel {
            background-color: #ff3b30;
        }
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            #main-content {
                margin-left: 0;
            }
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.collapsed {
            transform: translateX(-230px);
        }
        #toggleSidebar {
            position: fixed;
            left: 250px;
            top: 10px;
            z-index: 1000;
            transition: left 0.3s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar {
            left: 20px;
        }
        #main-content {
            transition: padding-left 0.3s ease-in-out;
        }
        .sidebar.collapsed + #main-content {
            padding-left: 40px;
        }
    </style>    
</head>
<body>
    <div class="container">
        <div id="sidebar" class="sidebar">
            <button id="toggleSidebar">‚â°</button>            
            <h2>Analytics</h2>
            <div class="analytics-card">
                <h3>Bookings</h3>
                <div class="analytics-item">
                    <span class="analytics-icon">üìÖ</span>
                    <span class="analytics-label">Daily</span>
                    <span id="dailyBookings" class="analytics-value">0</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-icon">üìÜ</span>
                    <span class="analytics-label">Weekly</span>
                    <span id="weeklyBookings" class="analytics-value">0</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-icon">üìÖ</span>
                    <span class="analytics-label">Monthly</span>
                    <span id="monthlyBookings" class="analytics-value">0</span>
                </div>
            </div>
            <div class="analytics-card">
                <h3>Hours Booked</h3>
                <div class="analytics-item">
                    <span class="analytics-icon">‚è±Ô∏è</span>
                    <span class="analytics-label">Daily</span>
                    <span id="dailyHours" class="analytics-value">0</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-icon">‚è±Ô∏è</span>
                    <span class="analytics-label">Weekly</span>
                    <span id="weeklyHours" class="analytics-value">0</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-icon">‚è±Ô∏è</span>
                    <span class="analytics-label">Monthly</span>
                    <span id="monthlyHours" class="analytics-value">0</span>
                </div>
            </div>
            <div class="analytics-card">
                <h3>Availability</h3>
                <div class="analytics-item">
                    <span class="analytics-icon">üìä</span>
                    <span class="analytics-label">Vacant Days</span>
                    <span id="vacantDays" class="analytics-value">0</span>
                </div>
                <div class="analytics-item">
                    <span class="analytics-icon">üìä</span>
                    <span class="analytics-label">Vacant Hours</span>
                    <span id="vacantHours" class="analytics-value">0</span>
                </div>
            </div>
        </div>
        <div id="main-content">
            <h1>DPP Meeting Room Booking - Version 4.4</h1>
            <div id="calendar"></div>
        </div>
    </div>
    <button id="logoutButton">Logout</button>

    <div id="bookingForm" class="booking-form">       
        <input type="text" id="meetingTitle" placeholder="Meeting Title">
        <select id="department">
            <option value="">Select Department</option>
            <option value="Department of Medical Services">Department of Medical Services</option>
            <option value="Department of Public Health">Department of Public Health</option>
            <option value="Department of Health Technology">Department of Health Technology</option>
            <option value="Department of Policy and Planning">Department of Policy and Planning</option>
            <option value="Department of Health Regulation">Department of Health Regulation</option>
        </select>
        <input type="time" id="startTime" required>
        <input type="time" id="endTime" required>
        <button onclick="saveBooking()">Save Booking</button>
        <button onclick="closeBookingForm()" class="cancel">Cancel</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAED2NeWY224WpucUIFIef6Ekm7lUufM0o",
            authDomain: "moh-meeting-room-booking.firebaseapp.com",
            databaseURL: "https://moh-meeting-room-booking-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "moh-meeting-room-booking",
            storageBucket: "moh-meeting-room-booking.appspot.com",
            messagingSenderId: "629503206549",
            appId: "1:629503206549:web:4b172b7f392b7aef0de79c",
            measurementId: "G-MDSDN8ZS5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get a reference to the database service
        const db = firebase.database();

        let calendar;
        let selectedDate;

      // Customizable Islamic month names
        const islamicMonths = [
            "Muharram", "Safar", "Rabiulaawal", "Rabiulakhir",
            "Jamadilawal", "Jamadilakhir", "Rejab", "Sya'ban",
            "Ramadan", "Syawal", "Zulkaedah", "Zulhijjah"
        ];

        // Adjustable offset for Islamic calendar
        let islamicDateOffset = 0;

        function getIslamicDate(date) {
            const adjustedDate = new Date(date.getTime() + islamicDateOffset * 24 * 60 * 60 * 1000);
            const islamicDate = new Intl.DateTimeFormat('en-u-ca-islamic', {
                day: 'numeric',
                month: 'numeric',
                year: 'numeric'
            }).format(adjustedDate);
            const [day, month, year] = islamicDate.split('/');
            return `${day} ${islamicMonths[parseInt(month) - 1]}`;
        }        
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                slotMinTime: '08:00:00',
                slotMaxTime: '18:00:00',
                allDaySlot: false,
                selectable: true,
                select: function(info) {
                    selectedDate = info.start;
                    document.getElementById('startTime').value = info.startStr.slice(11, 16);
                    document.getElementById('endTime').value = info.endStr.slice(11, 16);
                    document.getElementById('bookingForm').style.display = 'block';
                },
                eventClick: function(info) {
                    if (confirm(`Do you want to cancel the booking: ${info.event.title}?`)) {
                        db.ref('events/' + info.event.id).remove().then(() => {
                            info.event.remove();
                            updateAnalytics();
                        });
                    }
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    db.ref('events').once('value').then(function(snapshot) {
                        const events = [];
                        snapshot.forEach(function(childSnapshot) {
                            const event = childSnapshot.val();
                            event.id = childSnapshot.key;
                            events.push(event);
                        });
                        successCallback(events);
                    }).catch(failureCallback);
                },
                eventContent: function(arg) {
                    return {
                        html: `
                            <div class="fc-event-title">${arg.event.title}</div>
                            <div class="fc-event-time">${arg.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${arg.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        `
                    };
                },
                dayCellDidMount: function(info) {
                    const islamicDate = getIslamicDate(info.date);
                    const element = info.el.querySelector('.fc-daygrid-day-top');
                    if (element) {
                        const islamicDateElement = document.createElement('div');
                        islamicDateElement.className = 'islamic-date';
                        islamicDateElement.textContent = islamicDate;
                        element.appendChild(islamicDateElement);
                    }
                },
                datesSet: function(info) {
                    if (info.view.type === 'timeGridWeek' || info.view.type === 'timeGridDay') {
                        const dates = info.view.activeStart;
                        const endDate = info.view.activeEnd;
                        while (dates < endDate) {
                            const dayHeader = calendar.el.querySelector(`.fc-col-header-cell[data-date="${dates.toISOString().split('T')[0]}"]`);
                            if (dayHeader) {
                                const islamicDate = getIslamicDate(dates);
                                const islamicDateElement = document.createElement('div');
                                islamicDateElement.className = 'islamic-date';
                                islamicDateElement.textContent = islamicDate;
                                dayHeader.appendChild(islamicDateElement);
                            }
                            dates.setDate(dates.getDate() + 1);
                        }
                    }
                }
            });
            calendar.render();
            updateAnalytics();
        });       

        function saveBooking() {
            const title = document.getElementById('meetingTitle').value;
            const department = document.getElementById('department').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            if (title && department && startTime && endTime) {
                const startDateTime = new Date(selectedDate);
                const [startHours, startMinutes] = startTime.split(':');
                startDateTime.setHours(parseInt(startHours), parseInt(startMinutes));

                const endDateTime = new Date(selectedDate);
                const [endHours, endMinutes] = endTime.split(':');
                endDateTime.setHours(parseInt(endHours), parseInt(endMinutes));

                const newEvent = {
                    title: `${title} - ${department}`,
                    start: startDateTime.toISOString(),
                    end: endDateTime.toISOString(),
                    color: getDepartmentColor(department)
                };

                db.ref('events').push(newEvent).then(function(ref) {
                    calendar.addEvent(newEvent);
                    closeBookingForm();
                    updateAnalytics();
                });
            }
        }

        function closeBookingForm() {
            document.getElementById('bookingForm').style.display = 'none';
            document.getElementById('meetingTitle').value = '';
            document.getElementById('department').value = '';
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
        }

        function getDepartmentColor(department) {
            const colors = {
                'Department of Medical Services': '#007AFF',
                'Department of Public Health': '#34C759',
                'Department of Health Technology': '#FF3B30',
                'Department of Policy and Planning': '#FF9500',
                'Department of Health Regulation': '#5856D6'
            };
            return colors[department] || '#8E8E93';
        }

        function updateAnalytics() {
            // Implement analytics update logic here
            // This should query the Firebase database and update the sidebar with current statistics
        }

         document.getElementById('toggleSidebar').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        });

        // Function to adjust Islamic calendar offset
        function adjustIslamicCalendar(days) {
            islamicDateOffset += days;
            calendar.refetchEvents();
            calendar.render();
        }

        // Add buttons to adjust Islamic calendar
        const adjustButtons = `
            <div>
                <button onclick="adjustIslamicCalendar(-2)">-2 Days</button>
                <button onclick="adjustIslamicCalendar(-1)">-1 Day</button>
                <button onclick="adjustIslamicCalendar(1)">+1 Day</button>
                <button onclick="adjustIslamicCalendar(2)">+2 Days</button>
            </div>
        `;
        document.querySelector('.sidebar').insertAdjacentHTML('beforeend', adjustButtons);

    </script>
</body>
</html>
